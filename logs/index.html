<!DOCTYPE html>
<html lang="us">

    <head>
        <script src="jquery.min.js"></script>
        <style>
            /* Generated by Font Squirrel (http://www.fontsquirrel.com) on March 23, 2016 */
            @font-face {
                font-family: 'bebas_neue_regularregular';
                src: url('../www/fonts/bebasneue_regular-webfont.eot');
                src: url('../www/fonts/bebasneue_regular-webfont.eot?#iefix') format('embedded-opentype'),
                     url('../www/fonts/bebasneue_regular-webfont.woff2') format('woff2'),
                     url('../www/fonts/bebasneue_regular-webfont.woff') format('woff'),
                     url('../www/fonts/bebasneue_regular-webfont.ttf') format('truetype'),
                     url('../www/fonts/bebasneue_regular-webfont.svg#bebas_neue_regularregular') format('svg');
                font-weight: normal;
                font-style: normal;
            }
        </style>
        <style>
            body {
                font-family: 'bebas_neue_regularregular', 'Impact', 'Arial Narrow', sans-serif;
                background-color: #000;
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
            }

            canvas {
                position: absolute;
                top: 0;
                left: 0;
                margin: 0;
                width: 100%;
                height: 100%;
                cursor: move;
            }

            #controls {
                position: absolute;
                bottom: 20px;
                left: 0;
                right: 0;
                margin: auto;
                width: 100%;
                height: 40px;
                text-align: center;
            }

            .ee-button {
              font-family: 'bebas_neue_regularregular', 'Impact', 'Arial Narrow', sans-serif;
              font-size: 24px;
              padding: 4px 20px;
              border-radius: 34px;
              background: rgba(0,0,0,0.8);
              color: #fff;
              transition: all 0.2s;
              position: relative;

              min-height: 40px;
              box-sizing: border-box;
              border: 2px solid rgba(255,255,255,0.5);
              cursor: pointer;
              display: inline;
              z-index: 1;
              user-select: none;
              -moz-user-select: none;
              -webkit-user-select: none;
              -ms-user-select: none;
            }
            .ee-button-active {
                color: #000;
                background-color: rgba(0,0,0,0);
            }
            .ee-button-active::after {
                content: "";
                color: #000;
                text-align: center;
                padding-top: 2px;
                display: block;
                background: #fff;
                position: absolute;
                width: auto;
                height: auto;
                top: 2px;
                right: 2px;
                left: 2px;
                bottom: 2px;
                border-radius: 20px;
                border-color: rgba(255,255,255,1);
                z-index: -1;
            }
            .ee-button:focus {
                outline: none;
            }

            input[type=range] {
              width: 400px;
              height: 40px;
              display: inline;
              position: relative;
              top: 11px;
              background: none;
              -webkit-appearance: none;
              margin: 0;
              box-sizing: border-box;
              padding: 0;
              border: 0;
            }
            input[type=range]:focus {
              outline: none;
              border-color: rgba(255,255,255,1);
            }
            input[type=range]::-webkit-slider-runnable-track {
              width: 100%;
              height: 40px;
              cursor: pointer;
              background: rgba(0, 0, 0, 0.8);
              border-radius: 34px;
              border: 2px solid #ffffff;
            }
            input[type=range]::-webkit-slider-thumb {
              border: 3px solid #000000;
              height: 34px;
              width: 34px;
              border-radius: 34px;
              background: #ffffff;
              cursor: pointer;
              -webkit-appearance: none;
              margin-top: 1px;
            }
            input[type=range]:focus::-webkit-slider-runnable-track {
              background: rgba(28, 28, 28, 0.8);
            }
            input[type=range]::-moz-range-track {
              width: 100%;
              height: 40px;
              cursor: pointer;
              background: rgba(0, 0, 0, 0.8);
              border-radius: 34px;
              border: 2px solid rgba(255,255,255,0.5);
            }
            input[type=range]::-moz-range-thumb {
              border: 3px solid #000000;
              height: 34px;
              width: 34px;
              border-radius: 34px;
              background: #ffffff;
              cursor: pointer;
            }
            input[type=range]::-ms-track {
              width: 100%;
              height: 30px;
              cursor: pointer;
              background: transparent;
              border-color: transparent;
              color: transparent;
            }
            input[type=range]::-ms-fill-lower {
              background: rgba(0, 0, 0, 0.8);
              border: 2px solid rgba(255,255,255,0.5);
              border-radius: 34px;
            }
            input[type=range]::-ms-fill-upper {
              background: rgba(0, 0, 0, 0.8);
              border: 2px solid rgba(255,255,255,0.5);
              border-radius: 34px;
            }
            input[type=range]::-ms-thumb {
              border: 3px solid #000000;
              width: 34px;
              border-radius: 34px;
              background: #ffffff;
              cursor: pointer;
              height: 34px;
            }
            input[type=range]:focus::-ms-fill-lower {
              background: rgba(0, 0, 0, 0.8);
            }
            input[type=range]:focus::-ms-fill-upper {
              background: rgba(28, 28, 28, 0.8);
            }

            #dropzone {
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                margin: auto;
                vertical-align: middle;
                line-height: 4;
                width: 400px;
                height: 160px;
                background-color: #808098;
                border: 2px solid rgba(255,255,255,1);
                border-radius: 34px;
                box-sizing: border-box;
                text-align: center;
                font-size: 40px;
                color: #fff;
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                cursor: default;
            }
        </style>
    </head>

    <body>
        <canvas id="canvas" width="200" height="100" unselectable></canvas>
        <div id="controls" unselectable>
            <button class="ee-button" id="autoplay" unselectable>Play</button>
            <input id="time_selector" type="range" min="0" max="0" value="0">
            <button class="ee-button" id="callsigns" unselectable>Callsigns</button>
        </div>
        <div id="dropzone" unselectable>Drop log file here</div>
        <script>
            class LogData
            {
                constructor(text)
                {
                    this.entries = [];

                    var lines = text.match(/^.*([\n\r]+|$)/gm);
                    for (var index = 0; index < lines.length; index++)
                    {
                        try
                        {
                            if (lines[index].trim() != "")
                                this.entries.push(JSON.parse(lines[index]));
                        }catch(err){
                            console.debug("Read json line error: ", err);
                        }
                    }
                    console.debug("Loaded: " + this.entries.length + " log entries")
                }

                getMaxTime()
                {
                    return this.entries[this.entries.length-1].time;
                }

                getEntriesAtTime(time)
                {
                    var last_objects = {}
                    var static_objects = {}
                    for (var index = 0; index < this.entries.length; index++)
                    {
                        var entry = this.entries[index];
                        if (entry.time > time)
                            break
                        last_objects = entry.objects;
                        for(var i=0; i<entry.new_static.length; i++)
                        {
                            var obj = entry.new_static[i];
                            static_objects[obj.id] = obj;
                        }
                        for(var i=0; i<entry.del_static.length; i++)
                        {
                            var obj_id = entry.del_static[i];
                            delete static_objects[obj_id];
                        }
                    }
                    for(var i=0; i<last_objects.length; i++)
                    {
                        var obj = last_objects[i];
                        static_objects[obj.id] = obj;
                    }
                    return static_objects;
                }
            };

            class Canvas
            {
                constructor()
                {
                    this._canvas = $("#canvas");
                    this._canvas.mousedown(function(e) { canvas._mouseDown(e); });
                    this._canvas.mousemove(function(e) { canvas._mouseMove(e); });
                    this._canvas.mouseup(function(e) { canvas._mouseUp(e); });
                    this._canvas.bind('mousewheel', function(e) { e.stopPropagation(); e.preventDefault(); canvas._mouseWheel(e.originalEvent.wheelDelta); });
                    $(window).resize(function(e) { canvas.update(); });

                    this._view_x = 0;
                    this._view_y = 0;
                    this._zoom_scale = 100.0 / 20000.0; // 20U = 100 pixels at default zoom.
                    this.showCallsigns = false;

                    this.update()
                }

                _mouseDown(e)
                {
                    this._last_mouse_x = e.clientX
                    this._last_mouse_y = e.clientY
                }
                _mouseMove(e)
                {
                    if (!e.buttons)
                        return;

                    this._view_x += (this._last_mouse_x - e.clientX) / this._zoom_scale;
                    this._view_y += (this._last_mouse_y - e.clientY) / this._zoom_scale;

                    this._last_mouse_x = e.clientX;
                    this._last_mouse_y = e.clientY;

                    this.update();
                }
                _mouseUp(e)
                {
                    this._last_mouse_x = e.clientX
                    this._last_mouse_y = e.clientY
                }

                _mouseWheel(delta)
                {
                    // Cap delta to avoid impossible zoom scales.
                    delta = Math.max(delta, -999.99);
                    this._zoom_scale *= 1.0 + delta / 1000.0;
                    this.update();
                }

                update()
                {
                    var w = document.documentElement.clientWidth;
                    var h = document.documentElement.clientHeight;
                    this._canvas[0].width = w;
                    this._canvas[0].height = h;

                    // Cap the zoom scales to reasonable levels.
                    if (this._zoom_scale > 1.25) // 100px = 0.08U
                        this._zoom_scale = 1.25;
                    else if (this._zoom_scale < 0.000333) // 100px = 300U
                        this._zoom_scale = 0.000333;

                    var ctx = this._canvas[0].getContext("2d");
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(0, 0, w, h);

                    if (!log)
                        return

                    var time = $("#time_selector").val();

                    this.drawGrid(ctx, this._view_x, this._view_y, w, h, 20000.0, 1000000.0, "#00A");

                    ctx.fillStyle = "#FFFFFF";
                    var stateTextTime = formatTime(time);
                    var stateTextZoom = "100px = " + (0.1 / this._zoom_scale).toPrecision(3) + "U";
                    var stateTextX = "X: " + this._view_x.toPrecision(6);
                    var stateTextY = "Y: " + this._view_y.toPrecision(6);
                    var stateText = stateTextTime + " / " + stateTextZoom + " / " + stateTextX + " / " + stateTextY;
                    ctx.font="20px bebas_neue_regularregular, Impact, Arial, sans-serif";
                    ctx.fillText(stateText, 20, 40);

                    var entries = log.getEntriesAtTime(time);
                    for(var id in entries)
                    {
                        var entry = entries[id];
                        var x = (entry["position"][0] - this._view_x) * this._zoom_scale + w / 2.0;
                        var y = (entry["position"][1] - this._view_y) * this._zoom_scale + h / 2.0;

                        if (entry.type == "Nebula")
                        {
                            var r = 5000.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.2
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#202080";
                            ctx.fill();
                            ctx.globalAlpha = 1.0
                        }
                        else if (entry.type == "BlackHole")
                        {
                            var r = 5000.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.2
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#802020";
                            ctx.fill();
                            ctx.globalAlpha = 1.0
                        }
                        else if (entry.type == "WormHole")
                        {
                            var r = 5000.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.2
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#800080";
                            ctx.fill();
                            ctx.globalAlpha = 1.0
                        }
                        else if (entry.type == "Mine")
                        {
                            var r = 1000.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.2
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#808080";
                            ctx.fill();
                            ctx.globalAlpha = 1.0
                            ctx.fillStyle = "#FFFFFF";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "PlayerSpaceship")
                        {
                            this.drawShip(ctx, x, y, entry);
                        }
                        else if (entry.type == "CpuShip")
                        {
                            this.drawShip(ctx, x, y, entry);
                        }
                        else if (entry.type == "SpaceStation")
                        {
                            this.drawStation(ctx, x, y, entry);
                        }
                        else if (entry.type == "Asteroid")
                        {
                            ctx.fillStyle = "#FFC864";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "ScanProbe")
                        {
                            ctx.fillStyle = "#60C080";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "Nuke")
                        {
                            ctx.fillStyle = "#F40";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "EMPMissile")
                        {
                            ctx.fillStyle = "#0FF";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "HomingMissile")
                        {
                            ctx.fillStyle = "#FA0";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "HVLI")
                        {
                            ctx.fillStyle = "#AAA";
                            ctx.fillRect(x, y, Math.max(33 * this._zoom_scale, 1), Math.max(33 * this._zoom_scale, 1));
                        }
                        else if (entry.type == "VisualAsteroid")
                        {
                        }
                        else if (entry.type == "BeamEffect")
                        {
                            var r = 50.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.4
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#A60";
                            ctx.fill();
                        }
                        else if (entry.type == "ExplosionEffect")
                        {
                            var r = 100.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.4
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#FF0";
                            ctx.fill();
                        }
                        else if (entry.type == "ElectricExplosionEffect")
                        {
                            var r = 100.0 * this._zoom_scale;
                            ctx.globalAlpha = 0.4
                            ctx.beginPath();
                            ctx.arc(x, y, r, 0, 2 * Math.PI, false);
                            ctx.fillStyle = "#0FF";
                            ctx.fill();
                        }
                        else
                        {
                            console.debug("Unknown object type: ", entry.type)
                            ctx.fillStyle = "#FF0000";
                            ctx.fillRect(x, y, Math.max(66 * this._zoom_scale, 2), Math.max(66 * this._zoom_scale, 2));
                        }
                    }
                }

                drawGrid(ctx, x, y, canvasWidth, canvasHeight, gridPixelSize, gridSize, color)
                {
                    ctx.lineWidth = 0.5;
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color;
                    ctx.font = "20px bebas_neue_regularregular, Impact, Arial, sans-serif";

                    var gridlineX;
                    var gridlineY;

                    // Draw horizontal grid.
                    for(var i = -gridSize / 2; i <= gridSize / 2; i = i + gridPixelSize)
                    {
                        gridlineY = (i - y) * this._zoom_scale + canvasHeight / 2.0;
                        gridlineX = (i - x) * this._zoom_scale + canvasWidth / 2.0;

                        // Draw the gridline unless it falls off the canvas.
                        if ((gridlineY > 0) && (gridlineY < canvasHeight))
                        {
                            ctx.beginPath();
                            ctx.moveTo(0, gridlineY);
                            ctx.lineTo(canvasWidth, gridlineY);
                            ctx.closePath();
                            ctx.stroke();
                        }

                        if ((gridlineX > 0) && (gridlineX < canvasWidth))
                        {
                            ctx.beginPath();
                            ctx.moveTo(gridlineX, 0);
                            ctx.lineTo(gridlineX, canvasWidth);
                            ctx.closePath();
                            ctx.stroke();
                        }
                    }
                }

                getFactionColor(faction, lowColor, highColor)
                {
                    // Rudimentary faction ID; would be nice to use the list
                    // from factioninfo.lua. Returns a fillStyle string.
                    if (faction == "Human Navy")
                        return "#" + lowColor + highColor + lowColor;
                    else if (faction == "Independent")
                        return "#" + lowColor + lowColor + highColor;
                    else // Everybody else is evil
                        return "#" + highColor + lowColor + lowColor;
                }

                drawCallsign(ctx, x, y, zoom_scale, entry, fontSize, lowColor, highColor, textDrift)
                {
                    // Draw the object's callsign.
                    ctx.fillStyle = this.getFactionColor(entry.faction, lowColor, highColor);
                    ctx.font = fontSize + "px bebas_neue_regularregular, Impact, Arial, sans-serif";
                    var textDriftAmount = Math.max((textDrift * 33.333) * zoom_scale, textDrift);
                    ctx.fillText(entry.callsign, x + textDriftAmount, y + textDriftAmount);
                }

                drawStation(ctx, x, y, entry)
                {
                    // Get its faction color.
                    ctx.fillStyle = this.getFactionColor(entry.faction, "5", "F");

                    // Draw a circle and scale it by zoom and station type.
                    ctx.beginPath();

                    var sizeModifier;

                    if (entry.station_type == "Large Station")
                    {
                        sizeModifier = 6;
                    } else if (entry.station_type == "Medium Station") {
                        sizeModifier = 4;
                    } else {
                        sizeModifier = 3;
                    }

                    ctx.arc(x, y, Math.max((sizeModifier * 66.666) * this._zoom_scale, sizeModifier), 0, 2 * Math.PI, false);
                    ctx.fill();

                    // Draw its callsign.
                    if (this.showCallsigns === true)
                        this.drawCallsign(ctx, x, y, this._zoom_scale, entry, "18", "C8", "FF", sizeModifier);
                }

                drawShip(ctx, x, y, entry)
                {
                    // Use a brighter color for player ships.
                    var fillStyleMagnitude = "C";
                    if (entry.type == "PlayerSpaceship")
                        fillStyleMagnitude = "F";

                    // Get its faction color.
                    ctx.fillStyle = this.getFactionColor(entry.faction, "0", fillStyleMagnitude);

                    // Draw the ship rectangle and scale it on zoom.
                    ctx.fillRect(x - Math.max(66 * this._zoom_scale, 2), y - Math.max(66 * this._zoom_scale, 2), Math.max(120 * this._zoom_scale, 3), Math.max(120 * this._zoom_scale, 3));

                    // Draw its callsign. Draw player callsigns brighter.
                    if (this.showCallsigns === true)
                        this.drawCallsign(ctx, x, y, this._zoom_scale, entry, "18", "B8", fillStyleMagnitude, 2);

                    if (entry.config.beams)
                    {
                        for(var idx=0; idx<entry.config.beams.length; idx++)
                        {
                            var beam = entry.config.beams[idx];
                            var a = entry.rotation + beam.direction;
                            var r = beam.range * this._zoom_scale;
                            var a1 = (a - beam.arc / 2.0) / 180.0 * Math.PI
                            var a2 = (a + beam.arc / 2.0) / 180.0 * Math.PI
                            var x1 = x + Math.cos(a1) * r;
                            var y1 = y + Math.sin(a1) * r;
                            var x2 = x + Math.cos(a2) * r;
                            var y2 = y + Math.sin(a2) * r;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                            ctx.lineTo(x1, y1);
                            ctx.arc(x, y, r, a1, a2, false);
                            ctx.lineTo(x2, y2);
                            ctx.lineTo(x, y);

                            ctx.globalAlpha = 0.5
                            ctx.strokeStyle = "#FF0000";
                            ctx.stroke();
                            ctx.globalAlpha = 1.0
                        }
                    }
                }
            };

            function loadLog(data)
            {
                log = new LogData(data)
                if (log.entries.length > 0)
                {
                    $("#dropzone").hide()
                    console.debug(log.getMaxTime());
                    canvas.update();
                    $("#time_selector").attr("max", log.getMaxTime());
                }
            }

            function formatTime(time)
            {
                if (time % 60 < 10)
                    return Math.floor(time / 60) + ":0" + (time % 60)
                return Math.floor(time / 60) + ":" + (time % 60)
            }

            function autoPlay(isAutoplaying)
            {
                timeValue = parseInt($("#time_selector").val());
                timeValue += 1;
                $("#time_selector").val(timeValue);
                canvas.update();
                // If we reach the end, stop autoplaying.
                if (parseInt($("#time_selector").val()) >= parseInt($("#time_selector").attr("max")))
                {
                    return !isAutoplaying;
                }
                // Otherwise, keep going.
                return isAutoplaying;
            }

            var log;
            var canvas;

            $().ready(function()
            {
                document.addEventListener('dragover', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });
                document.addEventListener('drop', function(e)
                {
                    e.stopPropagation();
                    e.preventDefault();
                    var files = e.dataTransfer.files;
                    for (var i=0, file; file=files[i]; i++)
                    {
                        var reader = new FileReader();
                        reader.onload = function(e2) { loadLog(e2.target.result); }
                        reader.readAsText(file);
                    }
                });
                canvas = new Canvas();

                // Update the canvas when the time selector is modified.
                $("#time_selector").on("input change", function(e) {
                    canvas.update();
                });

                // Track the play/pause button.
                var isAutoplaying = false;

                $("#autoplay").on("click", function(e) {
                    if (log != null)
                    {
                        isAutoplaying = !isAutoplaying;
                        if (isAutoplaying === true)
                        {
                            if (parseInt($("#time_selector").val()) >= parseInt($("#time_selector").attr("max")))
                                $("#time_selector").val(0);
                            $("#autoplay").addClass("ee-button-active");
                        } else {
                            $("#autoplay").removeClass("ee-button-active");
                        }
                    }
                });

                // On an interval when autoplay is enabled, increment the time controller.
                var loopAutoplay = setInterval(function() {
                    if (isAutoplaying === true)
                    {
                        isAutoplaying = autoPlay(isAutoplaying);
                    } else {
                        $("#autoplay").removeClass("ee-button-active");
                    }
                }, 100);

                // Track whether to show callsigns.
                $("#callsigns").on("click", function(e) {
                    if (log != null)
                    {
                        canvas.showCallsigns = !canvas.showCallsigns;
                        canvas.update();
                        if (canvas.showCallsigns === true)
                            $("#callsigns").addClass("ee-button-active");
                        else
                            $("#callsigns").removeClass("ee-button-active");
                    }
                });
            });
        </script>

    </body>

</html>
